#!/usr/bin/env bash
# Install and configure Neovim and its dependencies
# This runs once before chezmoi applies the dotfiles

set -e

echo "==> Setting up Neovim..."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log() {
    echo -e "${GREEN}[nvim-setup]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[nvim-setup]${NC} $1"
}

error() {
    echo -e "${RED}[nvim-setup]${NC} $1"
}

# Check if neovim is installed
if ! command -v nvim &> /dev/null; then
    warn "Neovim not found. Please install it via:"
    echo "  brew install neovim"
    exit 1
fi

log "Neovim version: $(nvim --version | head -n1)"

# Check nvim version (need 0.10+)
NVIM_VERSION=$(nvim --version | head -n1 | grep -oE '[0-9]+\.[0-9]+' | head -n1)
REQUIRED_VERSION="0.10"

if ! awk -v ver="$NVIM_VERSION" -v req="$REQUIRED_VERSION" 'BEGIN{exit(!(ver>=req))}'; then
    error "Neovim $REQUIRED_VERSION or higher required (found $NVIM_VERSION)"
    warn "Please upgrade: brew upgrade neovim"
    exit 1
fi

# Check if build tools are available (needed for some plugins)
if ! command -v make &> /dev/null; then
    warn "make not found. Some Telescope extensions may not build correctly."
    echo "  Install Xcode Command Line Tools: xcode-select --install"
fi

# Check if node is installed (needed for some LSPs and Copilot)
if ! command -v node &> /dev/null; then
    error "Node.js not found. Required for LSPs and GitHub Copilot."
    echo "  Install via Homebrew: brew install node"
    exit 1
fi

log "Node.js version: $(node --version)"

# Check if Python is installed (needed for Python LSP)
if ! command -v python3 &> /dev/null; then
    warn "Python 3 not found. Python LSP won't work."
else
    log "Python version: $(python3 --version)"
fi

# Create nvim data directory if it doesn't exist
NVIM_DATA_DIR="$HOME/.local/share/nvim"
if [ ! -d "$NVIM_DATA_DIR" ]; then
    log "Creating nvim data directory: $NVIM_DATA_DIR"
    mkdir -p "$NVIM_DATA_DIR"
fi

# Inform user about first launch
log "Neovim configuration is ready!"
log ""
log "On first launch, nvim will automatically:"
log "  1. Install lazy.nvim (plugin manager)"
log "  2. Install all plugins"
log "  3. Install LSP servers via Mason"
log ""
log "After opening nvim for the first time:"
log "  - Run :Tutor to learn vim basics"
log "  - Run :Copilot setup to authenticate with GitHub"
log "  - Run :Mason to check LSP installation status"
log "  - Run :checkhealth to verify everything works"
log ""
log "Quick test: nvim ~/.config/nvim/README.md"
log ""
log "For more info, see: ~/.config/nvim/README.md"
